import { CONSTANTS } from '../../constants.mjs';
import { AbstractAssignAffinityStep } from './abstract-assign-affinity-step.mjs';

/**
 * @param {AffinityDataModel} affinity
 * @return boolean
 */
const validAffinity = (affinity) => {
  return !affinity.value;
};

const allDamageTypes = Object.keys(CONSTANTS.damageTypes);

const vulnerabilitiesKey = 'speciesVulnerabilities';

export class AssignSpeciesVulnerabilityStep extends AbstractAssignAffinityStep {
  static get stepName() {
    return 'QUICKNPC.step.assignAffinity.vulnerability';
  }

  static getOptions(model, context) {
    return context[vulnerabilitiesKey][0].filter((damageType) => {
      const affinity = model.affinities[damageType];
      return validAffinity(affinity);
    });
  }

  /**
   * @param context
   * @param {DamageType[]} options
   */
  static addSpeciesVulnerability(context, options = allDamageTypes) {
    options = options.filter((value) => allDamageTypes.includes(value));
    context[vulnerabilitiesKey] ??= [];
    context[vulnerabilitiesKey].push(options);
  }

  static shouldActivate(current, value, context) {
    return context[vulnerabilitiesKey]?.length;
  }

  doApply(value, context) {
    const affinity = value.affinities[this.damageType];
    if (!validAffinity(affinity)) {
      return false;
    } else {
      affinity.updateSource({ vul: 'species' });
      context[vulnerabilitiesKey].shift();
      return value;
    }
  }
}
